<style>
    tr.claimed {
        background-color: rgba(0, 200, 0, 0.1);
    }

    tr.profile {
        background-color: rgba(0, 200, 0, 0.2);
    }

    tr.no-release {
        background-color: rgba(228, 170, 23, 0.3);
    }

    tr.locked {
        background-color: rgba(200, 0, 0, 0.2);
    }
</style>

<div id="user-container">
    <h3 class="text-center flex-row" style="justify-content: space-between">
        <div style="width: 200px"></div>
        <div>Users</div>
        <div><input type="text"
                    class="admin-search de-parameter-input"
                    de-parameter="search"
                    de-parameters="start=0"
                    value="<%=search%>"></div>
    </h3>
    <%- include element-nav.ejs %>
    <table class="table table-responsive white-well">
        <tr>
            <th class="text-center"></th>
            <th class="text-center">Profile</th>
            <th class="text-center">Balance</th>
            <th class="text-center">Invited</th>
            <th class="text-center">Invite<br>Clicked</th>
            <th class="text-center">Linked</th>
            <th class="text-center">Music<br>Released</th>
            <th class="text-center">Invites<br>Left</th>
            <th class="text-center">Free<br>plays</th>
        </tr>

        <% for (var ivt = 0; ivt < users.length; ivt++) {
            var user = users[ivt];
            var checked = 'yes';
            var unchecked = '-';
            var invite = user.invite ? user.invite : {};
            var invitedBy = invite.invitedBy || {};
            var state = user.accountLocked ? "locked"
                    : user.blocked ? "no-release"
                            : invite.claimed
                                    ? (user.profileAddress && user.draftProfile.artistName) ? "profile" : "claimed"
                                    : "";
            var name = user.draftProfile && user.draftProfile.artistName ? user.draftProfile.artistName : "this user";
        %>
        <tr class="<%= state %>">
            <td class="text-center middle">
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Edit<span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="javascript:void(0)" onclick="verifyUser(this, '<%= user._id %>', '<%= name %>')"><%= user.verified ? "Unverify" : "Verify"%></a></li>

                        <li class="divider"></li>
                        <li><a href="javascript:void(0)" onclick="addFreePlays('<%= user._id %>', 10)">+10 free plays</a></li>
                        <li><a href="javascript:void(0)" onclick="addInvites('<%= user._id %>', 10)">+10 Invites</a></li>

                        <li class="divider"></li>
                        <li><a href="javascript:void(0)" onclick="clearFreePlays('<%= user._id %>', 0)">Zero free plays</a></li>
                        <% if (user.invite.noReward) { %>
                        <li><a onclick="blacklist('<%= user._id %>', false)">De-Blacklist (allow invite rewards)</a></li>
                        <% } else { %>
                        <li><a onclick="blacklist('<%= user._id %>', true)">Blacklist (no invite rewards)</a></li>
                        <% } %>
                        <li><a href="javascript:void(0)" onclick="blockUser(this, '<%= user._id %>', '<%= name %>')"><%= user.blocked ? "Unblock Releases" : "Block Releases"%></a></li>
                        <li><a href="javascript:void(0)" onclick="lockUserAccount(this, '<%= user._id %>', '<%= name %>')"><%= user.accountLocked ? "Unlock Account" : "Lock Account"%></a></li>
                    </ul>
                </div>
            </td>
            <td class="text-center middle">
                <% if(user.profileAddress && user.draftProfile.artistName) { %>
                <a target="_blank" href="/artist/<%= user.profileAddress %>"><%= user.draftProfile.artistName %></a>
                <% } else if (user.draftProfile && user.draftProfile.artistName) { %>
                <%= user.draftProfile.artistName %>
                <% } else { %>
                <%= unchecked %>
                <% } %>

                <% if (user.draftProfile && typeof user.draftProfile.version != "undefined") { %>
                (v<%= user.draftProfile.version %>)
                <% } %>
                <br>
                <%=user.timeSinceJoining%>
                <br>
                <a class="de-parameter-setter clickable"
                   de-parameters="invitedby=<%=user._id%>,search=,start=0"
                   title="show users invited by this user">
                    show invitees
                </a>
            </td>
            <td class="text-center middle">
                <%=user.balance%>
            </td>
            <td class="text-left middle">
                <%= invite.invitedAs %><br>
                <% if(invitedBy.profileAddress && invitedBy.draftProfile.artistName) { %>
                by <a target="_blank"
                   href="/artist/<%= invitedBy.profileAddress %>"><%= invitedBy.draftProfile.artistName %></a>
                <% } %>
                <BR>
                <%= invite.inviteCode %>
            </td>
            <td class="text-center middle"><%- invite.clicked ? checked : unchecked %></td>
            <td class="text-center middle">
                <table cellpadding="2">
                    <% if (!!user.google.token) { %>
                    <%
                        const googleUrl = user.google.url ? user.google.url : "https://plus.google.com/" + user.google.id;
                    %>
                    <tr>
                        <td><span class="btn fa fa-google-plus"></span></td>
                        <td class="text-left">
                            <a target=_blank href="<%= googleUrl %>">
                            <%- user.google.name %>, <%- user.google.email %>
                            </a>
                        </td>
                    </tr>
                    <% } %>

                    <% if (!!user.twitter.token) { %>
                    <tr>
                        <td><span class="btn fa fa-twitter"></span></td>
                        <td class="text-left">
                            <%
                             const twitterUrl = user.twitter.url ? user.twitter.url : "https://twitter.com/" + user.twitter.username;
                            %>
                            <a target=_blank href="<%= twitterUrl %>"> <%- user.twitter.username %>, <%- user.twitter.displayName %> </a>
                        </td>
                    </tr>
                    <% } %>

                    <% if (!!user.facebook.token) { %>
                    <%
                        const facebookUrl = user.facebook.url ? user.facebook.url : "https://www.facebook.com/app_scoped_user_id/" + user.facebook.id;
                    %>
                    <tr>
                        <td class=""><span class="btn fa fa-facebook"></span></td>
                        <td class="text-left">
                            <a target=_blank href="<%= facebookUrl %>">
                            <%- user.facebook.name %>, <%- user.facebook.email %>
                            </a>
                        </td>
                    </tr>
                    <% } %>

                    <% if (!!user.local.id) { %>
                    <tr>
                        <td><span class="btn fa fa-envelope-o"></span></td>
                        <td class="text-left"><%- user.local.email %></td>
                    </tr>
                    <% } %>
                </table>
            </td>
            <td class="text-center middle"><%- user.mostRecentReleaseDate ? checked : unchecked %></td>
            <td class="text-center middle"><%= user.invitesRemaining %></td>
            <td class="text-center middle"><%= user.freePlaysRemaining %></td>
        </tr>
        <% } %>
    </table>
</div>

<script>
  function addInvites(id, cnt) {
    $.post('/admin/invites/add', {
      id: id,
      count: cnt
    }, function (data) {
      if (data.success) {
        new Message("Invites added!", "success", 3000);
        refreshUserContainer();
      }
      else {
        new Message("Failed: " + data.reason, 'error', 5000)
      }
    })
  }

  function clearFreePlays(id) {
    $.post('/admin/free-plays/clear', {
      id: id
    }, function (data) {
      if (data.success) {
        new Message("This user will have no more free plays!", "success", 3000);
        refreshUserContainer();
      }
      else {
        new Message("Failed: " + data.reason, 'error', 5000)
      }
    })
  }

  function addFreePlays(id, cnt) {
    $.post('/admin/free-plays/add', {
      id: id,
      count: cnt
    }, function (data) {
      if (data.success) {
        new Message("Free plays added!", "success", 3000);
        refreshUserContainer();
      }
      else {
        new Message("Failed: " + data.reason, 'error', 5000)
      }
    })
  }

  function blacklist(id, blacklist) {
    $.post('/admin/invites/blacklist', {
      id: id,
      blacklist: blacklist
    }, function (data) {
      if (data.success) {
        new Message(blacklist ? "User blacklisted!" : "User de-blacklisted", "success", 3000);
        refreshUserContainer();

      }
      else {
        new Message("Failed: " + data.reason, 'error', 5000)
      }
    })
  }

  function lockUserAccount(element, id, name) {
    var button= $(element);
    var lock = button.text() == "Lock Account";
    var msg = lock
      ? "Are you sure you want to lock " + name + "? The user will not be able to log in."
      : "Are you sure you want to enable " + name + "? The user will be able to log in again.";
    var resultMsg = lock
      ? "User account locked"
      : "User account unlocked";

    new Message(msg, 'error', 5000)
      .button("Yes", function() {
        $.post('/admin/users/lock', {
          id: id,
          lock: lock
        }, function (data) {
          if (data.success) {
            $(element).text(lock ? "Unlock Account" : "Lock Account");
            $(element).toggleClass("btn-danger", !lock);
            $(element).toggleClass("btn-success", lock);
            new Message(resultMsg, "success", 3000);
            refreshUserContainer();
          }
          else {
            new Message("Failed: " + data.reason, 'error', 5000)
          }
        })
      })
  }

  function verifyUser(element, id, name) {
    var button= $(element);
    var verified = button.text() == "Verify";
    var msg = verified
      ? "Are you sure you want to verify " + name + "?"
      : "Are you sure you want remove verification for " + name + "?"
    var resultMsg = verified
      ? "User marked as verified"
      : "Verification flag removed";

    new Message(msg, 'error', 5000)
      .button("Yes", function() {
        $.post('/admin/users/verify', {
          id: id,
          verified: verified
        }, function (data) {
          if (data.success) {
            $(element).text(verified ? "Unverify" : "Verify");
            $(element).toggleClass("btn-warning", verified);
            $(element).toggleClass("btn-success", !verified);
            new Message(resultMsg, "success", 3000);
            refreshUserContainer();
          }
          else {
            new Message("Failed: " + data.reason, 'error', 5000)
          }
        })
      })
  }

  function blockUser(element, id, name) {
    var button= $(element);
    var block = button.text() == "Block Releases";
    var msg = block
        ? "Are you sure you want to block releases " + name + "?"
        : "Are you sure you want to enable releases" + name + "?";
    var resultMsg = block
        ? "User releases blocked"
        : "User releases enabled";

    new Message(msg, 'error', 5000)
      .button("Yes", function() {
        $.post('/admin/users/block', {
          id: id,
          block: block
        }, function (data) {
          if (data.success) {
            $(element).text(block ? "Unblock Releases" : "Block Releases");
            $(element).toggleClass("btn-warning", !block);
            $(element).toggleClass("btn-success", block);
            new Message(resultMsg, "success", 3000);
            refreshUserContainer();
          }
          else {
            new Message("Failed: " + data.reason, 'error', 5000)
          }
        })
      })
  }

  function refreshUserContainer() {
    dynamic.refreshElement($($("#user-container").closest('.dynamic-element')))
  }
</script>