<!doctype html>
<html>
<head>
    <title>Musicoin</title>
    <%- include partials/page-head.ejs %>
    <style>
        body {
            word-wrap:break-word;
            background-size: cover;
            margin-left: 5px;
            margin-right: 5px;
            background-image: url('<%=license.image%>');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
        }

        .track-image {
            background-size: cover;
            width: 128px;
            height: 128px;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 4px;
        }

        .track-name {
            font-weight: bold;
        }

        .chat-area {
            background-color: white;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            padding-top: 10px;
        }

        .chat-messages {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-content: flex-start;
            color: black;
            padding-bottom: 10px;
            padding-right: 10px;
            overflow-y: auto;
        }

        .chat-message-area {
            flex-grow: 1;
        }

        .chat-input-area {
            height: 40px;
            margin-top: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }

        .chat-input {
            display: flex;
        }

        #chat-input {
            width: 100%;
        }

        .chat-message {
            display: flex;
            flex-shrink: 0;
        }

        .sender-image {
            width: 64px;
            height: 64px;
            background-color: red;
            margin-right: 5px;
            margin-bottom: 5px;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
        }

        .chat-message-sender {
            font-weight: bold;
        }

        .chat-message-body {
            color: #333
        }

        .message-time {
            color: #aaa;
            font-weight: normal;
            margin-left: 10px;
        }

        .action-area {
            display: flex;
            align-items: center;
        }

        .message-scroller {
            height: 100%;
            min-height: 180px;
            overflow-y: auto;
        }

        .track-description-header {
            color: #333
        }

        blockquote {
            background-color: #eee;
        }

        .private-view {
            padding: 5px;
            margin-top: 10px;
        }

        .message-tip {
            font-size: 14pt;
        }

    </style>
</head>
<body>
<%- include partials/header.ejs %>
<div class="container">
    <h1>
        <%=license.title%>
    </h1>
    <div class="row">
        <div class="col-sm-4 flex-column mb20">
            <div class="m5 well white-well">
                <div class="flex-column center-text">
                    <div class="audio-track track-image show-off-container shadow clickable"
                         style="background-image: url('<%=license.image%>')">
                    </div>
                    <div class="audio-track clickable m10 text-large"
                            audioUrl='<%=license.audioUrl%>'
                            trackTitle='<%=license.title%>'
                            artistName='<%=license.artistName%>'
                            image='<%=license.image%>'
                            playCount='<%=license.playCount%>'
                            tipCount='<%=license.tipCount%>'
                            artistProfileAddress='<%=license.artistProfileAddress%>'
                            licenseAddress='<%=license.address%>'>
                        <i class="fa fa-play-circle" aria-hidden="true"></i> Play
                    </div>
                    <div class="track-artist mb10">Artist: <a href="/artist/<%=license.artistProfileAddress%>"><%=license.artistName%></a></div>
                    <div>
                        <div id="player-tip-button"
                             class="tip-button btn btn-success tip-button btn-xs"
                             recipient="<%=license.address%>"
                             amount="1"
                             text-success="Thanks! :)"
                             text-fail=":("
                             text-default="Tip (1 $MC)">
                            Tip (1 $MC)
                        </div>
                    </div>
                </div>
                <div class="flex-column mb20 <%= isArtist ? "private-view" : ""%>">
                    <% if (isArtist) { %>
                    <div class="track-description-header mb10">Only you (the artist) can edit this area.  If you want, say something about the track.</div>
                    <textarea id=trackDescription class="mb10" placeholder="Say something about '<%=license.title%>'"><%=description%></textarea>
                    <div class="button-bar">
                        <div id=btnSave class="btn btn-warning" onclick=saveTrackDescription()>Save</div>
                    </div>
                    <%} else if (description) {%>
                    <p></p>
                    <blockquote class="track-description-header">
                        <%=description%>
                        <div class="button-bar">
                            - <%=license.artistName%>
                        </div>
                    </blockquote>
                    <%}%>
                </div>
            </div>
        </div>
        <div class="col-sm-8 chat-area">
            <div class="chat-input-area">
                <% if (user.profileAddress) {%>
                <div class="chat-input">
                    <input id="chat-input" maxlength="1000" placeholder="Say something about '<%=license.title%>' by '<%=license.artistName%>'">
                </div>
                <% } else { %>
                <div class="text-warning text-center">You can join the conversation after you save your <a href="/profile">profile</a></div>
                <% } %>
            </div>
            <div class="dynamic-element message-scroller"
                 style="min-height: 180px"
                 id="de-track-messages"
                 de-refresh-period="10"
                 de-refresh-offset="10"
                 de-address="<%=license.address%>"
                 de-url="/elements/track-messages">
                <%- include('partials/track-messages.ejs', {messages: messages}) %>
            </div>
        </div>
    </div>
</div>

<script>
    var trackId = "<%=license.address%>"
  $( document ).ready(function() {
    const messages = $("#de-track-messages");
    const input = $("#chat-input");
    input.on('keydown', function(e) {
      if(e.keyCode == 13) {
        var message = input.val();
        input.val("");
        dynamic.refreshElement(messages, {message: message});
      }
    });
  });

  function saveTrackDescription() {
    $("#btnSave").text("Saving...");
    $.post('/track/description', {
      contractAddress: trackId,
      description: $("#trackDescription").val(),
    }, function (data) {
      console.log("Saved");
      $("#btnSave").text("Saved!");
      window.setTimeout(() => $("#btnSave").text("Save"), 3000);
    })
  }

  function refreshMessageList() {
    dynamic.refreshElement($("#de-track-messages"));
  }
</script>
<%- include partials/player-hook.ejs %>
<%- include partials/connect-with-us.ejs %>
</body>
</html>
