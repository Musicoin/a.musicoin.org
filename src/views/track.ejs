<!doctype html>
<html>
<head>
    <title>Musicoin</title>
    <%- include partials/page-head.ejs %>
    <style>
        body {
            word-wrap:break-word;
            background-size: cover;
            margin-left: 5px;
            margin-right: 5px;
            background-image: url('<%=license.image%>');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
        }

        .track-image {
            width: 128px;
            height: 128px;
            background-color: blue;
            margin-bottom: 5px;
        }

        .track-name {
            font-weight: bold;
        }

        .chat-area {
            background-color: white;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            padding-top: 10px;
        }

        .chat-messages {
            height: 100%;
            display: flex;
            flex-direction: column-reverse;
            align-content: flex-end;
            color: black;
            padding-bottom: 10px;
            padding-right: 10px;
            overflow-y: auto;
        }

        .chat-message-area {
            flex-grow: 1;
        }

        .chat-input-area {
            height: 40px;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
        }

        #chat-input {
            width: 100%;
        }

        .chat-message {
            display: flex;
            flex-shrink: 0;
        }

        .sender-image {
            width: 64px;
            height: 64px;
            background-color: red;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .chat-message-sender {
            font-weight: bold;
        }

        .chat-message-body {
            color: #333
        }

        .message-time {
            color: #aaa;
            font-weight: normal;
            margin-left: 10px;
        }

        .action-area {
            display: flex;
            align-items: center;
        }

        .message-scroller {
            height: 100%;
            max-height: 300px;
            min-height: 180px;
            overflow-y: auto;
        }

        .track-description-header {
            color: #333
        }

        blockquote {
            background-color: #eee;
        }
        .track-image {
            background-size: cover;
            height: 100px;
            width: 100px;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<%- include partials/header.ejs %>
<div class="container">
    <h1>
        <%=license.title%>
    </h1>
    <div class="row">
        <div class="col-sm-3 flex-column mb20">
            <div class="audio-track track-image show-off-container shadow clickable"
                 audioUrl='<%=license.audioUrl%>'
                 trackTitle='<%=license.title%>'
                 artistName='<%=license.artistName%>'
                 image='<%=license.image%>'
                 playCount='<%=license.playCount%>'
                 tipCount='<%=license.tipCount%>'
                 artistProfileAddress='<%=license.artistProfileAddress%>'
                 licenseAddress='<%=license.address%>'
                 style="background-image: url('<%=license.image%>')">
                <div class="show-off"></div>
            </div>
            <div class="track-artist mb10"><%=license.artistName%></div>
            <div>
                <div id="player-tip-button"
                     class="tip-button btn btn-success tip-button btn-xs"
                     recipient="<%=license.artistProfileAddress%>"
                     amount="1"
                     text-success="Thanks! :)"
                     text-fail=":("
                     text-default="Tip Artist (1 $MC)">
                    Tip Artist (1 $MC)
                </div>
            </div>
        </div>
        <div class="col-sm-8 chat-area">
            <div class="flex-column mb20">
                <% if (isArtist) { %>
                <div class="track-description-header mb10">Only you (the artist) can edit this area.  If you want, say something about the track.</div>
                <textarea id=trackDescription class="mb10" placeholder="Say something about '<%=license.title%>'"><%=description%></textarea>
                <div class="button-bar">
                    <div class="btn btn-warning" onclick=saveTrackDescription()>Save</div>
                </div>
                <%} else if (description) {%>
                <h3 class="track-description-header mb10">About this track</h3>
                <blockquote class="track-description-header">
                    <%=description%>
                    <div class="button-bar">
                        - <%=license.artistName%>
                    </div>
                </blockquote>
                <%}%>
            </div>
            <div class="dynamic-element message-scroller"
                 style="min-height: 180px"
                 id="de-track-messages"
                 de-refresh-period="10"
                 de-refresh-offset="10"
                 de-address="<%=license.address%>"
                 de-url="/elements/track-messages"
                 de-auto-scroll="true">
                <%- include('partials/track-messages.ejs', {messages: messages}) %>
            </div>
            <div class="chat-input-area">
                <% if (user.profileAddress) {%>
                <div class="chat-input">
                    <input id="chat-input" placeholder="Say something about '<%=license.title%>' by '<%=license.artistName%>'">
                </div>
                <% } else { %>
                <div class="text-warning text-center">You can join the conversation after you save your <a href="/profile">profile</a></div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    var trackId = "<%=license.address%>"
  $( document ).ready(function() {
    const messages = $("#de-track-messages");
    const input = $("#chat-input");
    messages.scrollTop(messages[0].scrollHeight);
    input.on('keydown', function(e) {
      if(e.keyCode == 13) {
        var message = input.val();
        input.val("");
        dynamic.refreshElement(messages, {message: message});
      }
    });
  });

  function saveTrackDescription() {
    $.post('/track/description', {
      contractAddress: trackId,
      description: $("#trackDescription").val(),
    }, function (data) {
      console.log("Saved");
    })
  }

  function refreshMessageList() {
    dynamic.refreshElement($("#de-track-messages"));
  }
</script>
<%- include partials/player-hook.ejs %>
<%- include partials/connect-with-us.ejs %>
</body>
</html>
