<!doctype html>
<html>
<head>
    <%- include partials/page-head.ejs %>
    <title>Profile - Musicoin.org</title>
    <style>
        .profile-image {
            justify-content: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .social-group {
            display: flex;
            flex-direction: column;
        }
        .flex-row {
            display: flex;
            flex-direction: row;
        }
        .stat {
            margin-right: 20px;
        }
        .upload-image {
            cursor:pointer;
            width: 96px;
            height: 96px;
            object-fit: contain;
            background-color: rgba(255,255,255,0.1);
        }
        .instructions {
        }
        .form-entry {
            background-color: rgba(255,255,255,0.1);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-weight: normal;
            color: #aaa
        }

        input.form-control {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
        }
        textarea.form-control {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
        }
        h3 {
            font-family: monospace;
            text-transform: lowercase;
            text-align: center;
            margin-top: 10px;
        }
        .profile-release-item {
            display:flex;
            flex-direction: column;
            min-height:100px;
            justify-content: space-around;
            padding-left: 10px;
            width: 100%;
        }
        .balance {
            font-size: 72px;
            line-height: 0.9;
            text-align: center;
        }
        .wallet-action-toggle {
            text-align: left;
            cursor: pointer;
        }
        input.form-number {
            max-width: 100px;
        }

        .profile-release-item > * {
            margin-bottom: 10px;
        }
        .row-template {
            display: none;
        }
        .release-distribution {
        }

        #licensePreview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 400px;
            border-radius: 4px;
            z-index: 2;
            background-color: white;
            display: none;
            color: black;
        }
        .contributors {
            margin-top: 20px;
            margin-bottom: 0;
        }
        .wallet-actions {
        }
        .wallet-action-bar {
            justify-content: space-between;
        }
    </style>
</head>
<body>
<%- include partials/header.ejs %>
<div class="container">

    <div>
        <div class="col-sm-6">
            <div class="well">
                <h3>Public Profile</h3>
                <form id=profileForm action="/profile/save" enctype="multipart/form-data" method="post">
                    <div class="form-group profile-image">
                        <img id="profileImage" style="min-width: 64px; min-height: 64px; width: 256px; max-height:256px; object-fit: contain"  src="<%=user.profile.image%>">
                        (click to change)
                        <input style="display: none" id="imageInput" type="file" name="photo">
                    </div>
                    <div class="form-group">
                        <label>Artist Name</label>
                        <input type="text" class="form-control" name="artistName" value="<%=user.profile.artistName%>" placeholder="enter your band or artist name">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description"  placeholder="let people know who you are"><%= user.profile.description %></textarea>
                    </div>
                    <div class="form-group">
                        <label>social</label>
                        <br>
                        <p class="subtle-text">Add links to your social network profile pages so your fans can follow you!</p>
                        <table class="social-group">
                            <%
                            var socialTypes = [
                                {id: "website", name: "artist website", icon: "fa-external-link"},
                                {id: "google", icon:"fa-google-plus"},
                                "facebook", "twitter",
                                {id: "soundcloud", name: "sound cloud"}, "linkedin", "youtube",
                                {id: "reverbnation", icon:"fa-star", name: "reverb nation"},
                                "pinterest", "instagram", "medium"
                            ]
                            for (var i=0; i < socialTypes.length; i++) {
                              var item = socialTypes[i];
                              if (typeof item == "string") {
                                item = {id: item};
                              }
                              var value = user.profile && user.profile.social ? user.profile.social[item.id] : "";
                              var name = item.name ? item.name : item.id;
                              var icon = item.icon ? item.icon : "fa-" + item.id;
                            %>
                                <tr>
                                    <td><span class="fa <%=icon%>"></span></td>
                                    <td width="99%"><input type="text" class="form-control" name="social.<%=item.id%>" value="<%=value%>" placeholder="<%=name%>"></td>
                                </tr>
                            <%}%>
                        </table>
                    </div>
                    <% if (user.profileAddress) {%>
                    <div class="text-center">
                        View your public profile page here <a href="/artist/<%=user.profileAddress%>">here</a>
                    </div>
                    <% } else { %>
                    <div class="text-center">By publishing your profile, you agree to our <a href="/terms">terms of use</a></div>
                    <% } %>
                    <div style="display:flex; justify-content: flex-end">
                        <button type="submit" class="btn btn-warning btn-lg">
                            <%= (user.pendingTx || user.profileAddress) ? "Update" : "Publish" %>
                        </button>
                    </div>
                    <% if (user.pendingTx) {%>
                    <div>
                        Waiting for confirmation (<%=user.pendingTx%>)
                    </div>
                    <% }  %>

                </form>

            </div>
        </div>
    </div>

    <div class="row">
        <!-- LOCAL INFORMATION -->
        <!--<div class="col-sm-6">-->
            <!--<div class="well">-->
                <!--<h3><span class="fa fa-user"></span> Local</h3>-->

                <!--<% if (user.local.email) { %>-->
                <!--<p>-->
                    <!--<strong>email</strong>: <%= user.local.email %><br>-->
                <!--</p>-->

                <!--<a href="/unlink/local" class="btn btn-default">Unlink</a>-->
                <!--<% } else { %>-->
                <!--<a href="/connect/local" class="btn btn-default">Connect Local</a>-->
                <!--<% } %>-->

            <!--</div>-->
        <!--</div>-->

        <!--<div class="col-sm-6">-->
            <!--<div class="well">-->
                <!--<h3 class="text-danger"><span class="fa fa-google-plus"></span> Google+</h3>-->

                <!--&lt;!&ndash; check if the user has this token (is the user authenticated with this social account) &ndash;&gt;-->
                <!--<% if (user.google.token) { %>-->
                    <!--<p>-->
                        <!--<strong>email</strong>: <%= user.google.email %><br>-->
                        <!--<strong>name</strong>: <%= user.google.name %>-->
                    <!--</p>-->

                    <!--<a href="/unlink/google" class="btn btn-danger">Unlink</a>-->
                <!--<% } else { %>-->
                    <!--<a href="/connect/google" class="btn btn-danger">Connect Google</a>-->
                <!--<% } %>-->

            <!--</div>-->
        <!--</div>-->

        <% if (user.canInvite) {%>
        <div class="col-sm-6">
            <div class="well">
                <h3>Alpha Testers</h3>
                <p class="subtle-text">
                    Add an email address to the whitelist. Note that is must be a google address, and they must
                    use that address when signing in.
                </p>
                <p class="subtle-text">
                    After you add them to the list, be sure to let them know!  (This form will not send an email)
                </p>
                <form action="/invite" method="post">
                    <table cellpadding="3">
                        <tr>
                            <td class="text-nowrap">e-mail</td>
                            <td width="99%"><input name=email type="text" class="form-control" placeholder="email (google)"></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="text-right">
                                <button type="submit" class="btn btn-warning">
                                    Add
                                </button>
                            </td>
                        </tr>
                        <% if (invited.email) { %>
                        <tr>
                            <td></td>
                            <td>
                            <% if (invited.success) {%>
                                <%=invited.email%> was added to the whitelist.
                            <%} else {%>
                                Failed to invite <%=invited.email%>
                            <%}%>
                            </td>
                        </tr>
                        <% } %>
                    </table>
                </form>
            </div>
        </div>
        <%}%>

        <% if (user.profileAddress) {%>

        <div class="col-sm-6">
            <div class="well">
                <h3>my wallet</h3>
                <div>
                    <div class="balance"><%=artist.formattedBalance%></div>
                    <div class="text-center subtle-text">musicoins</div>
                </div>
                <div class=wallet-actions style="display: none">
                    <p>
                    <div class="text-center subtle-text">my wallet address</div>
                    <div class="text-center"><%=user.profileAddress%></div>
                    <p></p>

                    <p class="subtle-text">
                        Send musicoins to a friend or transfer to another wallet for safe keeping.
                    </p>
                    <form action="/send" method="post">
                        <table cellpadding="3">
                            <tr>
                                <td>Recipient</td>
                                <td width="99%"><input name=recipient type="text" class="form-control" placeholder="address"></td>
                            </tr>
                            <tr>
                                <td>Amount</td>
                                <td>
                                    <div class="flex-row">
                                        <input name=amount type="number" class="form-control text-right form-number" placeholder="0">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td class="text-right">
                                    <button type="submit" class="btn btn-warning">
                                        Send
                                    </button>
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
                <div class="flex-row wallet-action-bar">
                    <div onclick='$(".wallet-actions").toggle()' class="wallet-action-toggle subtle-text wallet-actions">show options</div>
                    <div onclick='$(".wallet-actions").toggle()' class="wallet-action-toggle subtle-text wallet-actions" style="display: none">hide options</div>
                    <a class="subtle-text" href="/tx/history/<%=user.profileAddress%>">show history</a>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="well">
                <h3>Release</h3>
                <form id=releaseForm action="/license/release" enctype="multipart/form-data" method="post">
                    <% for (let i=0; i < 1; i++) {
                        const rowId = `track${i}`;
                        const displayId = rowId + "_imageDisplay";
                    %>
                    <div class="flex-row">
                        <div class="flex-column clickable" onclick="<%=rowId%>_image.click()" >
                            <img src="<%=user.profile.image%>" id="<%=displayId%>" class="upload-image">
                            <div class="text-center small">
                                (click to change)
                            </div>
                        </div>

                        <div class="profile-release-item">
                            <input class="no-submit form-control" type="text" name="<%=rowId%>.title" placeholder="title">
                            <label class="no-submit form-entry" for="<%=rowId%>_audio" id="<%=rowId%>_audioLabel">Audio...</label>
                            <input style="display: none" onchange="updateAudioLabel('<%=rowId%>_audioLabel', this.id)" id="<%=rowId%>_audio" type="file" name="<%=rowId%>.audio">
                            <input style="display: none" onchange="updateImageDisplay('<%=displayId%>', this.id)" id="<%=rowId%>_image" type="file" name="<%=rowId%>.image">
                        </div>
                    </div>

                    <div class="release-distribution" style="display: none">
                        <table class="table table-condensed table-responsive contributors">
                            <tr>
                                <th class="col-md-5">recipient <a href="/faq#WhatIsARecipient" target="help">(?)</a></th>
                                <th class="col-md-1">shares <a href="/faq#WhatAreShares" target="help">(?)</a></th>
                            </tr>
                            <tr class="row-template" style="display: none">
                                <td><input name="address"
                                           class="no-submit form-control"
                                           placeholder="email, wallet, or license address"></td>
                                <td><input name="value"
                                           class="no-submit form-control text-right"
                                           placeholder=""></td>
                            </tr>
                            <tr>
                                <td><label style="width: 100%"
                                           class="form-entry">My wallet</label>
                                    <input style="display: none"
                                           name="track0.recipient.address"
                                           class="no-submit form-control"
                                           value="<%=user.profileAddress%>"></td>
                                <td><input name="track0.recipient.value"
                                           class="no-submit form-control text-right"
                                           value="1"
                                           placeholder=""></td>
                            </tr>
                        </table>
                        <div class="text-right">
                            <div class="btn btn-sm btn-link" onclick="addRow()" >
                            <span class="glyphicon glyphicon-plus" value="Add"></span>
                             add another entry
                            </div>
                        </div>
                    </div>
                    <div id="licensePreview"></div>
                    <%}%>

                    <button id=releaseButton style="display: none" type="submit"></button>
                    <div style="display:flex; justify-content: flex-end">
                        <div onclick='$( "#licensePreview" ).load( "/license/preview", loadLicenseFields() ); $("#licensePreview").show()'
                             class="btn btn-success">
                            Preview
                        </div>
                    </div>
                    <div class="wallet-action-toggle subtle-text"
                         onclick='$(".release-distribution").toggle()'>
                        <div class="release-distribution">not a solo act? show distribution options</div>
                        <div class="release-distribution" style="display: none">hide distribution options</div>
                    </div>
                </form>
            </div>
        </div>

        <% if (pendingReleases.length > 0) {%>
        <div class="col-sm-6">
            <div class="well">
                <h3>Pending</h3>
                <% for (var i=0; i < pendingReleases.length; i++) {%>
                    <div><%=pendingReleases[i].title%></div>
                <%}%>

            </div>
        </div>
        <%}%>

        <% if (releases.length > 0) {%>
        <div class="col-sm-6">
            <div class="well">
                <h3>My Releases</h3>
                <%- include partials/release-list.ejs %>
            </div>
        </div>
        <%}%>

        <%} else {%>
        <div class="col-sm-6">
            <div class="well">
                <h3>wallet</h3>
                Once you publish a profile, you can check your balance here and send coins to other users.
            </div>
        </div>

        <div class="col-sm-6">
            <div class="well">
                <h3>release</h3>
                Once you publish a profile, you can release songs here.
            </div>
        </div>
        <%}%>
    </div>

</div>
<%- include partials/player.ejs %>
</body>
<script>
  (function($) {

    // prevent dynamically created input elements from submitting the form
    $('.contributors').on('keydown', '.no-submit', function(e) {
      if(e.keyCode == 13) {
        console.log('No way it will still submit the form...');
        return false;
      }
    });
  })(jQuery);

  $( document ).ready(function() {
    $("#imageInput").change(function(){
      readURL('profileImage', this);
    });

    $("#profileImage").click(function() {
      $("#imageInput").click();
    })

    $.fn.serializeObject = function()
    {
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
        if (o[this.name] !== undefined) {
          if (!o[this.name].push) {
            o[this.name] = [o[this.name]];
          }
          o[this.name].push(this.value || '');
        } else {
          o[this.name] = this.value || '';
        }
      });
      return o;
    };

  });

  var counter = 0;
  function addRow() {
    console.log("Adding row " + counter);
    var newItem = $(".row-template").clone();
    newItem.removeClass("row-template");
    newItem.css("display", "");
    newItem.find("input[name=address]").attr("name", "track0.recipient" + counter + ".address");
    newItem.find("input[name=value]").attr("name", "track0.recipient" + counter + ".value");
    newItem.appendTo(".contributors");
    counter++;
  }

  function readURL(targetId, input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();

      reader.onload = function (e) {
        $('#' + targetId).attr('src', e.target.result);
      }

      reader.readAsDataURL(input.files[0]);
    }
  }

  function updateImageDisplay(targetId, inputId) {
    readURL(targetId, $('#' + inputId)[0]);
  }

  function updateAudioLabel(targetId, inputId) {
    var fileInput = $('#' + inputId)[0];
    var fileName = fileInput.files[0].name;
    var display = $('#' + targetId)[0];
    if (fileName.endsWith(".mp3") || fileName.endsWith(".mpg") || fileName.endsWith(".mpeg")) {
      display.innerText = fileName;
    }
    else {
      fileInput.value = "";
      display.innerText = "Audio...";
      alert("Currently, Musicoin only supports mp3 format");
    }
  }

  function loadLicenseFields() {
    return $("#releaseForm").serializeObject();
  }
</script>
</html>